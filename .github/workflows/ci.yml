name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ['1.25.x']
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}
        cache: true

    - name: Verify Go version
      run: go version

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Build
      run: go build -v ./...

    - name: Run tests (macOS)
      if: matrix.os == 'macos-latest'
      run: go test -v -timeout 300s -race -coverprofile=coverage.out -covermode=atomic ./...

    - name: Run tests (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: go test -v -timeout 300s -coverprofile=coverage.out -covermode=atomic ./...

    - name: Run tests (Windows)
      if: runner.os == 'Windows'
      run: go test -v -timeout 300s ./...

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.x'
        cache: true

    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v8
      with:
        version: latest
        args: --timeout=5m

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.x'

    - name: Check formatting
      run: |
        if [ -n "$(gofmt -l .)" ]; then
          echo "The following files are not formatted:"
          gofmt -l .
          exit 1
        fi

    - name: Run go vet
      run: go vet ./...

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build-and-test, lint, format-check]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.x'
        cache: true

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install semantic-release and dependencies
      run: |
        npm install -g --loglevel=error \
          semantic-release@23 \
          @semantic-release/git@10 \
          @semantic-release/changelog@6 \
          @semantic-release/commit-analyzer@11 \
          @semantic-release/release-notes-generator@12 \
          @semantic-release/github@9 \
          @semantic-release/exec@6 \
          conventional-changelog-conventionalcommits@7

    - name: Create build script
      run: |
        cat > build-binaries.sh << 'EOF'
        #!/bin/bash
        set -e

        VERSION=$1
        COMMIT=$(git rev-parse HEAD)
        SOURCE_URL="https://github.com/$GITHUB_REPOSITORY"
        GO_VERSION=$(go version | awk '{print $3}')

        echo "Building binaries with version: $VERSION"
        echo "Commit: $COMMIT"
        echo "Go version: $GO_VERSION"

        mkdir -p release-binaries

        # Build matrix
        declare -a builds=(
          "linux:amd64:"
          "linux:arm64:"
          "linux:arm:7"
          "darwin:amd64:"
          "darwin:arm64:"
          "windows:amd64:"
          "windows:arm64:"
        )

        for build in "${builds[@]}"; do
          IFS=':' read -r GOOS GOARCH GOARM <<< "$build"

          if [ "$GOOS" = "windows" ]; then
            if [ -n "$GOARM" ]; then
              OUTPUT="open-context_${GOOS}_${GOARCH}v${GOARM}.exe"
            else
              OUTPUT="open-context_${GOOS}_${GOARCH}.exe"
            fi
          else
            if [ -n "$GOARM" ]; then
              OUTPUT="open-context_${GOOS}_${GOARCH}v${GOARM}"
            else
              OUTPUT="open-context_${GOOS}_${GOARCH}"
            fi
          fi

          echo "Building $OUTPUT..."

          LDFLAGS="-s -w"
          LDFLAGS="$LDFLAGS -X 'main.Tag=$VERSION'"
          LDFLAGS="$LDFLAGS -X 'main.Commit=$COMMIT'"
          LDFLAGS="$LDFLAGS -X 'main.SourceURL=$SOURCE_URL'"
          LDFLAGS="$LDFLAGS -X 'main.GoVersion=$GO_VERSION'"

          if [ -n "$GOARM" ]; then
            GOOS=$GOOS GOARCH=$GOARCH GOARM=$GOARM go build -v -o "release-binaries/$OUTPUT" -ldflags="$LDFLAGS"
          else
            GOOS=$GOOS GOARCH=$GOARCH go build -v -o "release-binaries/$OUTPUT" -ldflags="$LDFLAGS"
          fi

          if [ "$GOOS" != "windows" ]; then
            chmod +x "release-binaries/$OUTPUT"
          fi
        done

        ls -lah release-binaries/
        EOF

        chmod +x build-binaries.sh

    - name: Create .releaserc.json
      run: |
        cat > .releaserc.json << 'EOF'
        {
          "branches": ["master"],
          "plugins": [
            [
              "@semantic-release/commit-analyzer",
              {
                "preset": "conventionalcommits",
                "releaseRules": [
                  {"type": "feat", "release": "minor"},
                  {"type": "fix", "release": "patch"},
                  {"type": "perf", "release": "patch"},
                  {"type": "revert", "release": "patch"},
                  {"type": "docs", "release": false},
                  {"type": "style", "release": false},
                  {"type": "chore", "release": false},
                  {"type": "refactor", "release": "patch"},
                  {"type": "test", "release": false},
                  {"type": "build", "release": false},
                  {"type": "ci", "release": false}
                ]
              }
            ],
            [
              "@semantic-release/release-notes-generator",
              {
                "preset": "conventionalcommits",
                "presetConfig": {
                  "types": [
                    {"type": "feat", "section": "Features"},
                    {"type": "fix", "section": "Bug Fixes"},
                    {"type": "perf", "section": "Performance Improvements"},
                    {"type": "revert", "section": "Reverts"},
                    {"type": "docs", "section": "Documentation", "hidden": false},
                    {"type": "style", "section": "Styles", "hidden": true},
                    {"type": "chore", "section": "Miscellaneous Chores", "hidden": true},
                    {"type": "refactor", "section": "Code Refactoring"},
                    {"type": "test", "section": "Tests", "hidden": true},
                    {"type": "build", "section": "Build System", "hidden": true},
                    {"type": "ci", "section": "Continuous Integration", "hidden": true}
                  ]
                }
              }
            ],
            "@semantic-release/changelog",
            [
              "@semantic-release/exec",
              {
                "prepareCmd": "./build-binaries.sh v${nextRelease.version}"
              }
            ],
            [
              "@semantic-release/github",
              {
                "assets": [
                  {"path": "release-binaries/open-context_linux_amd64"},
                  {"path": "release-binaries/open-context_linux_arm64"},
                  {"path": "release-binaries/open-context_linux_armv7"},
                  {"path": "release-binaries/open-context_darwin_amd64"},
                  {"path": "release-binaries/open-context_darwin_arm64"},
                  {"path": "release-binaries/open-context_windows_amd64.exe"},
                  {"path": "release-binaries/open-context_windows_arm64.exe"}
                ],
                "successComment": false,
                "failComment": false
              }
            ],
            [
              "@semantic-release/git",
              {
                "assets": ["CHANGELOG.md"],
                "message": "chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}"
              }
            ]
          ]
        }
        EOF

    - name: Run semantic-release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: npx semantic-release
